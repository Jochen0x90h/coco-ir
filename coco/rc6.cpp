#include "rc6.hpp"
#include "irTools.hpp"


namespace coco {
namespace rc6 {

/*
    Examples
    Philips TV
    On: 0,54,16,10,16,10,7,10,7,27,25,10,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,18,7,10,16,10,7,10 | 0,53,17,9,17,10,7,9,7,10,16,17,8,9,7,10,7,9,7,9,7,9,7,9,7,9,7,10,8,9,7,9,7,10,7,18,7,9,17,10,7,9
    OK: 0,54,16,10,16,10,7,9,7,27,25,10,7,9,7,9,7,10,7,9,7,9,8,9,7,10,7,18,16,18,7,10,7,9,17,10,7,10 | 0,54,16,9,16,10,7,9,7,9,16,18,7,9,8,9,7,9,7,9,7,9,7,9,7,9,7,9,8,18,16,18,7,10,7,9,16,9,7,9
    Left: 0,54,16,10,16,10,7,10,7,27,25,10,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,18,16,18,7,10,16,18,16,10 | 0,54,16,10,16,10,7,10,7,10,16,18,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,18,16,18,7,10,16,18,16,10
    Right: 0,54,16,10,16,10,7,10,7,27,25,10,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,18,16,18,7,10,16,18,7,10 | 0,54,16,10,16,10,7,9,8,10,16,18,7,10,7,9,8,9,8,10,7,10,7,9,8,10,7,10,7,18,16,18,7,10,16,18,7,10
    Up: 0,54,17,9,17,9,8,8,8,27,26,9,8,9,8,9,8,8,8,8,8,8,8,8,8,9,8,18,17,18,8,8,17,9,8,8,8,9 | 0,54,16,10,16,10,7,10,7,10,16,18,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,18,16,18,7,10,16,10,7,10,7,10
    Down: 0,54,16,9,16,10,7,10,7,27,25,9,7,9,8,10,7,9,7,9,7,9,7,9,8,10,7,18,16,18,7,10,16,10,7,18 | 0,52,18,8,18,8,9,8,9,8,18,17,9,8,9,8,9,8,9,9,8,9,8,9,8,9,8,9,8,18,17,17,8,8,17,9,8,18
    0: 0,54,16,10,16,10,7,10,7,27,25,10,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,10 | 0,54,16,10,16,10,7,9,7,10,16,18,7,10,7,10,7,10,7,10,7,10,7,9,7,9,7,9,8,10,7,10,7,10,7,10,7,9,8,9,7,9,7,10
    1: 0,54,16,10,16,10,7,10,7,27,25,10,7,10,7,10,7,10,7,10,7,10,7,9,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,18 | 0,54,16,10,16,10,7,10,7,10,16,18,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,10,7,18
    2: 0,53,17,9,16,9,8,9,7,26,26,9,8,8,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,17,17,9 | 0,53,17,9,17,9,8,9,8,9,17,17,8,9,8,9,8,9,8,9,8,9,8,9,8,8,8,9,8,9,8,9,8,9,8,9,8,9,8,17,17,9
    3: 0,53,17,9,17,9,8,9,8,26,26,9,8,9,8,9,8,9,8,8,8,9,8,9,8,9,8,8,8,9,8,8,8,9,8,9,8,18,8,8 | 0,53,17,9,17,9,8,9,8,9,17,17,8,9,8,9,8,9,8,9,8,8,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,17,8,9
    4: 0,53,17,9,17,9,8,9,8,26,26,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,17,17,9,8,9 | 0,52,18,8,18,8,9,8,9,8,18,17,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,17,18,8,9,8
    5: 0,52,18,8,18,8,9,8,9,26,27,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,17,18,17 | 0,53,17,9,16,10,8,9,8,8,17,18,8,9,8,8,8,8,8,9,8,9,8,9,8,8,8,9,8,9,8,9,8,9,8,9,8,17,17,17
    6: 0,53,17,8,17,8,9,8,9,26,26,8,9,9,8,8,8,8,9,8,9,8,8,8,9,8,9,8,9,8,9,8,9,8,9,17,8,8,18,8 | 0,52,18,8,18,8,9,8,9,8,18,17,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,17,9,8,18,8
    7: 0,52,18,8,18,8,9,8,9,26,27,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,17,9,8,9,8 | 0,52,18,8,18,8,9,8,9,8,18,17,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,17,9,8,9,8
    8: 0,52,18,8,18,8,9,8,9,26,27,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,17,18,8,9,8,9,8 | 0,52,18,8,18,8,9,8,9,8,18,17,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,17,18,8,9,8,9,8
    9: 0,53,17,8,17,9,8,9,8,27,26,9,8,9,8,8,8,9,8,9,8,8,8,9,8,9,8,8,8,9,8,9,8,17,17,9,8,18 | 0,53,17,9,17,9,8,9,8,9,17,17,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,9,8,17,17,9,8,18
*/

bool decode(Array<const uint8_t> times, Packet &packet) {
    if (times.size() < 20)
        return false;

    // leader
    if (!checkLeader(times.data(), 2666us, 889us))
        return false;

    // decode (MSB first)
    ManchesterDecoder decoder(times.data() + 3, times.size() - 3);

    // header (start bit, 3 mode bits)
    uint8_t header;
    if (!decoder.decode(444us, 444us, &header, 4))
        return false;

    // trailer (toggles on new key press)
    uint8_t trailer;
    if (!decoder.decode(889us, 889us, &trailer, 1))
        return false;

    // data
    uint8_t data[2];
    if (!decoder.decode(444us, 444us, data, 16))
        return false;

    packet.mode = header & 7;
    packet.trailer = trailer;
    packet.control = data[0];
    packet.data = data[1];

    return true;
}

} // namespace rc6
} // namespace coco
